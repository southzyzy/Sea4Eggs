! -----------------------------------
! Manually go to "enable" mode and
! "conf t" before using the config
! commands below!
! -----------------------------------

no call-home reporting anonymous

hostname TheGreatWall
domain-name intranet.sea4eggs.sitict.net

! -----------------------------------
! Disable HTTP management
! -----------------------------------
no http server enable

! -----------------------------------
! Disable SNMP
! -----------------------------------
no snmp-server enable traps snmp authentication linkup linkdown coldstart warmstart

! -----------------------------------
! Default inspection policy
! -----------------------------------
policy-map global_policy
class inspection_default
inspect icmp
exit
exit

! -----------------------------------
! Allow traffic of same security level
! -----------------------------------
same-security-traffic permit inter-interface

! -----------------------------------
! Interface configuration
! -----------------------------------
interface GigabitEthernet0/0
nameif EDGE-ROUTER
security-level 0
ip address 172.16.0.2 255.255.255.252
no shutdown

interface GigabitEthernet0/1
nameif R1-MGNT-SYSLOG
security-level 100
ip address 172.16.4.1 255.255.255.252
no shutdown

interface GigabitEthernet0/2
nameif R2-DMZ
security-level 50
ip address 172.16.3.1 255.255.255.252 
no shutdown

interface GigabitEthernet0/3
shutdown
no nameif    
no security-level
no ip address
             
interface GigabitEthernet0/4
nameif L3SW1 
security-level 80
ip address 172.16.1.1 255.255.255.252
no shutdown

interface GigabitEthernet0/5
nameif L3SW2 
security-level 80
ip address 172.16.2.1 255.255.255.252
no shutdown

interface Management0/0
nameif management
security-level 100
ip address 172.16.68.2 255.255.255.240
no shutdown

exit

! -----------------------------------
! Static routes
! We don't want to deal with dynamic
! routing protocol related attacks
! -----------------------------------
route EDGE-ROUTER 0.0.0.0 0.0.0.0 172.16.0.1 1

route R1-MGNT-SYSLOG 172.16.67.0 255.255.255.252 172.16.4.2 1

route R2-DMZ 172.16.69.0 255.255.255.252 172.16.3.2 1
route R2-DMZ 172.16.81.0 255.255.255.252 172.16.3.2 1

route L3SW1 172.16.30.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.31.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.37.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.66.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.100.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.110.0 255.255.255.240 172.16.1.2 1
route L3SW1 172.16.200.0 255.255.255.248 172.16.1.2 1
route L3SW1 172.16.210.0 255.255.255.224 172.16.1.2 200

route L3SW2 172.16.30.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.31.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.37.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.66.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.100.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.110.0 255.255.255.240 172.16.2.2 200
route L3SW2 172.16.200.0 255.255.255.248 172.16.2.2 200
route L3SW2 172.16.210.0 255.255.255.224 172.16.2.2 1

! -----------------------------------
! Ghetto way to force route some management
! traffic to R1-MGNT-SYSLOG
! -----------------------------------
route R1-MGNT-SYSLOG 172.16.68.1 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.3 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.4 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.5 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.6 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.7 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.8 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.9 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.10 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.11 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.12 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.13 255.255.255.255 172.16.4.2
route R1-MGNT-SYSLOG 172.16.68.14 255.255.255.255 172.16.4.2


! -----------------------------------
! NTP syncronisation
! -----------------------------------
clock timezone SGT 8
ntp server 172.16.67.2 prefer

! -----------------------------------
! Syslog configuration
! -----------------------------------
logging trap 6
logging host R1-MGNT-SYSLOG 172.16.67.2
logging timestamp
logging enable


! -----------------------------------
! Object Group - Networks
! -----------------------------------
object-group network PARTNERS
network-object 172.16.100.0 255.255.255.248
exit

object-group network ASSOCIATES
network-object 172.16.110.0 255.255.255.240
exit

object-group network LAW_CLERKS
network-object 172.16.200.0 255.255.255.248
exit

object-group network LEGAL_SECRETARIES
network-object 172.16.210.0 255.255.255.224
exit

object-group network IT_SUPPORT
network-object 172.16.30.0 255.255.255.248
exit

object-group network MARKETING_LEADS
network-object 172.16.31.0 255.255.255.248
exit

object-group network CHIEF_LEGAL_OFFICE
network-object 172.16.37.0 255.255.255.248
exit

object-group network INTERNAL_SERVER_NET
network-object 172.16.66.0 255.255.255.248
exit

object-group network SYSLOG_NET
network-object 172.16.67.0 255.255.255.252
exit

object-group network MANAGEMENT_NET
network-object 172.16.68.0 255.255.255.240
exit

object-group network HONEYPOT_NET
network-object 172.16.69.0 255.255.255.252
exit

object-group network DMZ_NET
network-object 172.16.81.0 255.255.255.252
exit

object-group network R1_FW_UPLINK
network-object 172.16.4.0 255.255.255.252
exit

object-group network R2_FW_UPLINK
network-object 172.16.3.0 255.255.255.252
exit

! -----------------------------------
! Object Group - Hosts
! -----------------------------------
object-group network EDGE_ROUTER_MGNT
network-object host 172.16.0.1
exit

object-group network R2_DMZ_MGNT
network-object host 172.16.3.2
exit

object-group network L3SW1_UPLINK
network-object host 172.16.1.2
exit

object-group network L3SW2_UPLINK
network-object host 172.16.2.2
exit

object-group network SYSLOG_SERVER
network-object host 172.16.67.2
exit

object-group network TACACS_SERVER
network-object host 172.16.68.8
exit

object-group network DMZ_SERVER
network-object host 172.16.81.2
exit

object-group network HONEYPOT_SERVER
network-object host 172.16.69.2
exit

object-group network DNS_SERVER
network-object host 172.16.66.3
exit

! -----------------------------------
! Object Group - Group Aliases
! -----------------------------------
object-group network INTERNAL_NETWORK
group-object PARTNERS
group-object ASSOCIATES
group-object LAW_CLERKS
group-object LEGAL_SECRETARIES
group-object IT_SUPPORT
group-object MARKETING_LEADS
group-object CHIEF_LEGAL_OFFICE
group-object INTERNAL_SERVER_NET
exit

object-group network WAN_FACING_SERVICES
group-object DMZ_SERVER
group-object HONEYPOT_SERVER
exit

object-group network IT_MANAGEMENT
group-object MANAGEMENT_NET
group-object SYSLOG_NET
exit

! -----------------------------------
! Service groups
! -----------------------------------
object-group service SYSLOG_TRAFFIC
service-object udp destination eq 123
service-object udp destination eq 514
service-object tcp destination eq 9997
service-object icmp
exit

object-group service NETFLOW_TRAFFIC
service-object udp destination eq 9991
service-object icmp
exit

object-group service TACACS_TRAFFIC
service-object tcp destination eq 49
service-object icmp
exit

object-group service DMZ_TRAFFIC
service-object tcp destination eq 80
service-object tcp-udp destination eq 53
exit

object-group service HONEYPOT_TRAFFIC
service-object tcp destination eq 21
service-object tcp destination eq 22
exit

object-group service DNS_TRAFFIC
service-object tcp-udp destination eq 53
exit

object-group service DMZ_SYSLOG_TRAFFIC
service-object udp destination eq 9992
service-object udp destination eq ntp
service-object icmp
exit

! -----------------------------------
! Time ranges
! -----------------------------------
time-range OFFICE_HOURS
periodic weekdays 9:00 to 18:00
exit

! -----------------------------------
! Access Control Lists
! -----------------------------------
access-list DMZ_HTTP_SERVER extended permit tcp any4 object-group DMZ_SERVER eq 80

! -----------------------------------
! EDGE-ROUTER
! -----------------------------------
! Permit EDGE-ROUTER access to SYSLOG_SERVER and TACACS_SERVER
access-list EDGE_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group EDGE_ROUTER_MGNT object-group SYSLOG_SERVER
access-list EDGE_INBOUND extended permit object-group NETFLOW_TRAFFIC object-group EDGE_ROUTER_MGNT object-group SYSLOG_SERVER
access-list EDGE_INBOUND extended permit object-group TACACS_TRAFFIC object-group EDGE_ROUTER_MGNT object-group TACACS_SERVER

! Permit specified traffic to DMZ_SERVER and HONEYPOT_SERVER
access-list EDGE_INBOUND extended permit object-group DMZ_TRAFFIC any4 object-group DMZ_SERVER
access-list EDGE_INBOUND extended permit object-group HONEYPOT_TRAFFIC any4 object-group HONEYPOT_SERVER

! Explicit deny any
access-list EDGE_INBOUND extended deny ip any any

access-group EDGE_INBOUND in interface EDGE-ROUTER

! -----------------------------------
! R1-MGNT-SYSLOG
! -----------------------------------
! Deny access to HONEYPOT_NET
access-list R1_MGNT_INBOUND extended deny ip any object-group HONEYPOT_NET

access-list R1_MGNT_INBOUND extended permit object-group DNS_TRAFFIC object-group IT_MANAGEMENT object-group DNS_SERVER

! Deny SYSLOG_NET to EDGE-ROUTER (SSH), R2-DMZ and INTERNAL_NET and DMZ_NET
access-list R1_MGNT_INBOUND extended deny tcp object-group SYSLOG_NET object-group EDGE_ROUTER_MGNT eq 22
access-list R1_MGNT_INBOUND extended deny ip object-group SYSLOG_NET object-group R2_FW_UPLINK
access-list R1_MGNT_INBOUND extended deny ip object-group SYSLOG_NET object-group INTERNAL_NETWORK
access-list R1_MGNT_INBOUND extended deny ip object-group SYSLOG_NET object-group DMZ_NET

! Permit all other traffic (Internet access)
access-list R1_MGNT_INBOUND extended permit ip any4 any4

access-group R1_MGNT_INBOUND in interface R1-MGNT-SYSLOG

! -----------------------------------
! R2-DMZ
! -----------------------------------
! Permit DMZ_SERVER access to SYSLOG_SERVER
access-list R2_DMZ_INBOUND extended permit object-group DMZ_SYSLOG_TRAFFIC object-group DMZ_SERVER object-group SYSLOG_SERVER

! Permit R2-DMZ access to SYSLOG_SERVER and TACACS_SERVER
access-list R2_DMZ_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group R2_DMZ_MGNT object-group SYSLOG_SERVER
access-list R2_DMZ_INBOUND extended permit object-group TACACS_TRAFFIC object-group R2_DMZ_MGNT object-group TACACS_SERVER

! Deny any access to EDGE-ROUTER (SSH), R1-MGNT-SYSLOG, INTERNAL_NETWORK and IT_MANAGEMENT
access-list R2_DMZ_INBOUND extended deny tcp any object-group EDGE_ROUTER_MGNT eq 22
access-list R2_DMZ_INBOUND extended deny ip any object-group R1_FW_UPLINK
access-list R2_DMZ_INBOUND extended deny ip any object-group INTERNAL_NETWORK
access-list R2_DMZ_INBOUND extended deny ip any object-group IT_MANAGEMENT

! Permit all other traffic (Internet access)
access-list R2_DMZ_INBOUND extended permit ip any4 any4

access-group R2_DMZ_INBOUND in interface R2-DMZ

! -----------------------------------
! L3SW1
! -----------------------------------
! Deny access to HONEYPOT_NET
access-list L3SW1_INBOUND extended deny ip any object-group HONEYPOT_NET

! Allow L3SW1 access to SYSLOG_SERVER and TACACS_SERVER
access-list L3SW1_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group L3SW1_UPLINK object-group SYSLOG_SERVER
access-list L3SW1_INBOUND extended permit object-group TACACS_TRAFFIC object-group L3SW1_UPLINK object-group TACACS_SERVER

! Allow INTERNAL_SERVER_NET access to SYSLOG_SERVER
access-list L3SW1_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group INTERNAL_SERVER_NET object-group SYSLOG_SERVER

! Permit INTERNAL_NETWORK web access (HTTP) and ICMP to DMZ_SERVER
access-list L3SW1_INBOUND extended permit icmp object-group INTERNAL_NETWORK object-group DMZ_SERVER
access-list L3SW1_INBOUND extended permit tcp object-group INTERNAL_NETWORK object-group DMZ_SERVER eq 80

! Allow IT_SUPPORT to access Management Network Jumphost (TACACS) via SSH and SYSLOG Web UI via HTTP/HTTPS, as well as ICMP
access-list L3SW1_INBOUND extended permit icmp object-group IT_SUPPORT object-group TACACS_SERVER
access-list L3SW1_INBOUND extended permit tcp object-group IT_SUPPORT object-group TACACS_SERVER eq 22
access-list L3SW1_INBOUND extended permit icmp object-group IT_SUPPORT object-group SYSLOG_SERVER
access-list L3SW1_INBOUND extended permit tcp object-group IT_SUPPORT object-group SYSLOG_SERVER eq 80
access-list L3SW1_INBOUND extended permit tcp object-group IT_SUPPORT object-group SYSLOG_SERVER eq 443

! Deny any access to EDGE-ROUTER (SSH), R1-MGNT-SYSLOG, R2-DMZ, IT_MANAGEMENT and DMZ_NET
access-list L3SW1_INBOUND extended deny tcp any object-group EDGE_ROUTER_MGNT eq 22
access-list L3SW1_INBOUND extended deny ip any object-group R1_FW_UPLINK
access-list L3SW1_INBOUND extended deny ip any object-group R2_FW_UPLINK
access-list L3SW1_INBOUND extended deny ip any object-group IT_MANAGEMENT
access-list L3SW1_INBOUND extended deny ip any object-group DMZ_NET

! Deny LEGAL_SECRETARIES traffic to internet during OFFICE_HOURS
access-list L3SW1_INBOUND extended deny ip object-group LEGAL_SECRETARIES any time-range OFFICE_HOURS

! Permit all other traffic (Internet access)
access-list L3SW1_INBOUND extended permit ip any4 any4

access-group L3SW1_INBOUND in interface L3SW1

! -----------------------------------
! L3SW2
! -----------------------------------
! Deny access to HONEYPOT_NET
access-list L3SW2_INBOUND extended deny ip any object-group HONEYPOT_NET

! Allow L3SW2 access to SYSLOG_SERVER and TACACS_SERVER
access-list L3SW2_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group L3SW2_UPLINK object-group SYSLOG_SERVER
access-list L3SW2_INBOUND extended permit object-group TACACS_TRAFFIC object-group L3SW2_UPLINK object-group TACACS_SERVER

! Allow INTERNAL_SERVER_NET access to SYSLOG_SERVER
access-list L3SW2_INBOUND extended permit object-group SYSLOG_TRAFFIC object-group INTERNAL_SERVER_NET object-group SYSLOG_SERVER

! Permit INTERNAL_NETWORK web access (HTTP) and ICMP to DMZ_SERVER
access-list L3SW1_INBOUND extended permit icmp object-group INTERNAL_NETWORK object-group DMZ_SERVER
access-list L3SW2_INBOUND extended permit tcp object-group INTERNAL_NETWORK object-group DMZ_SERVER eq 80

! Allow IT_SUPPORT to access Management Network Jumphost (TACACS) via SSH and SYSLOG Web UI via HTTP/HTTPS, as well as ICMP
access-list L3SW2_INBOUND extended permit icmp object-group IT_SUPPORT object-group TACACS_SERVER
access-list L3SW2_INBOUND extended permit tcp object-group IT_SUPPORT object-group TACACS_SERVER eq 22
access-list L3SW2_INBOUND extended permit icmp object-group IT_SUPPORT object-group SYSLOG_SERVER
access-list L3SW2_INBOUND extended permit tcp object-group IT_SUPPORT object-group SYSLOG_SERVER eq 80
access-list L3SW2_INBOUND extended permit tcp object-group IT_SUPPORT object-group SYSLOG_SERVER eq 443

! Deny any access to EDGE-ROUTER (SSH), R1-MGNT-SYSLOG, R2-DMZ, IT_MANAGEMENT and DMZ_NET
access-list L3SW2_INBOUND extended deny tcp any object-group EDGE_ROUTER_MGNT eq 22
access-list L3SW2_INBOUND extended deny ip any object-group R1_FW_UPLINK
access-list L3SW2_INBOUND extended deny ip any object-group R2_FW_UPLINK
access-list L3SW2_INBOUND extended deny ip any object-group IT_MANAGEMENT
access-list L3SW2_INBOUND extended deny ip any object-group DMZ_NET

! Deny LEGAL_SECRETARIES traffic to internet during OFFICE_HOURS
access-list L3SW2_INBOUND extended deny ip object-group LEGAL_SECRETARIES any time-range OFFICE_HOURS

! Permit all other traffic (Internet access)
access-list L3SW2_INBOUND extended permit ip any4 any4

access-group L3SW2_INBOUND in interface L3SW2

! -----------------------------------
! HTTP Traffic Inspection
! -----------------------------------
class-map DMZ_HTTP_TRAFFIC
match access-list DMZ_HTTP_SERVER
exit

policy-map INSPECT_DMZ_HTTP_TRAFFIC
class DMZ_HTTP_TRAFFIC
set connection embryonic-conn-max 15 per-client-embryonic-max 10
set connection per-client-max 15
set connection timeout idle 0:0:10
exit
exit

service-policy INSPECT_DMZ_HTTP_TRAFFIC interface EDGE-ROUTER
service-policy INSPECT_DMZ_HTTP_TRAFFIC interface L3SW1
service-policy INSPECT_DMZ_HTTP_TRAFFIC interface L3SW2
service-policy INSPECT_DMZ_HTTP_TRAFFIC interface R1-MGNT-SYSLOG

! -----------------------------------
! Threat detection
! -----------------------------------
threat-detection statistics tcp-intercept rate-interval 3 burst-rate 60 average-rate 30

! -----------------------------------
! Authentication configuration
! -----------------------------------
username sea4eggs-admin password 1qwer$#@!~sea4eggs
enable password C0mpl3xP@ssw0rd

! crypto key generate rsa modulus 2048

ssh version 2
ssh timeout 30
ssh 172.16.68.0 255.255.255.240 management

aaa-server TACACSERVER protocol tacacs+
aaa-server TACACSERVER (management) host 172.16.68.8 Sea4EggsC0mpl3xP@ssw0rd
server-port 49
exit

aaa authentication ssh console TACACSERVER LOCAL
aaa authentication enable console TACACSERVER LOCAL
aaa accounting ssh console TACACSERVER
aaa accounting enable console TACACSERVER
aaa accounting command TACACSERVER
aaa authorization command TACACSERVER LOCAL

end
